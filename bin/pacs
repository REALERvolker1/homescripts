#!/usr/bin/zsh
# vlk's pacs, an actually good search functionality for Arch Linux pacman based on dnfs
set -euo pipefail
TAB=$'\t' LF=$'\n'

PKGCACHE="$XDG_RUNTIME_DIR/${0##*/}.cache"

set -A vardeps
for i in pacman fzf grep; do
    command -v "$i" &>/dev/null || vardeps+=("$i")
done
((${#vardeps})) && echo "Missing dependencies: ${vardeps[*]}" && exit 1
unset vardeps

typeset -i REFRESH
set -A query
for i in "$@"; do
    case "${i:-}" in
    --refresh | -S)
        REFRESH=1
        ;;
    *)
        [[ -n ${i//[:IFSSPACE:]/} ]] && query+=("$i")
        ;;
    esac
done
IFS="$LF$TAB"

# [[ -n $PKGCACHE*(#qN) ]]
[[ ! -f $PKGCACHE ]] && REFRESH=1

if ((REFRESH)); then
    echo "Refreshing package cachefile..."
    pacman -Si | grep -E '^(Repository|Name|Version|Description|Architecture)' >"$PKGCACHE"
fi
