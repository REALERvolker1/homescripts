#!/usr/bin/dash
IFS="$(printf '\n\t')"

_head() {
    printf '\033[0;1m[\033[%sm%s\033[0;1m]\033[0m\n' "${1:-$distro_color}" "${2:?Put header here}"
}
distro_color="$(grep -oP '^ANSI_COLOR="\K[^"]*' /etc/os-release)"
[ -z "${distro_color:-}" ] && distro_color='31'

if command -v dnf >/dev/null; then
    # support dnf5 on Fedora Rawhide
    if file /usr/bin/dnf | grep -q 'dnf5$'; then
        _head "$distro_color" 'dnf5'
        sudo dnf makecache
        sudo dnf upgrade
    else
        _head "$distro_color" 'dnf'
        sudo dnf upgrade --refresh
    fi
fi

if command -v yay >/dev/null; then
    _head 35 'yay'
    yay -Syu --devel
    sudo pacman -Fy >/dev/null &
elif command -v pacman >/dev/null; then
    _head 92 'pacman'
    sudo pacman -Syu
    sudo pacman -Fy >/dev/null &
fi

if command -v apt >/dev/null; then
    _head 91 'apt'
    sudo apt update
    sudo apt upgrade
fi

distrobox_script="command -v yay >/dev/null 2>&1 && yay -Syu --noconfirm;\
command -v pacman >/dev/null 2>&1 && sudo pacman -Syu --noconfirm;\
command -v dnf >/dev/null 2>&1 && sudo dnf upgrade --refresh -y;\
command -v apt >/dev/null 2>&1 && sudo apt update && sudo apt upgrade -y"

if command -v distrobox >/dev/null; then
    boxes="$(distrobox ls --no-color 2>/dev/null | cut -d '|' -f 2 | tail -n '+2' | sed 's/^[ ]*//g ; s/[ ]*$//g')"
    for i in $boxes; do
        _head 96 "distrobox $i"
        echo "entering distrobox $i"
        distrobox-enter -n "$i" -- /bin/sh -c "$distrobox_script"
    done
fi

#if [ -d "$HOME/.local/opt/codium" ] && command -v codium-install.sh >/dev/null; then
#    _head 94 'codium'
#    codium-install.sh
#fi

# vlk-install.sh --update

if command -v flatpak >/dev/null; then
    _head 34 'flatpak'
    flatpak update -y
fi

if command -v cargo-install-update >/dev/null; then
    _head 33 'cargo'
    cargo install-update -a -g
fi
