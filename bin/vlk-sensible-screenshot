#!/usr/bin/dash

_panic() {
    type="${1:-Unspecified}"
    msg="${2:-Error}"
    echo "[${0##*/}] [$type] $msg"
    notify-send -a "${0##*/}" "$type" "$msg"
    exit 1
}

swappy="- | swappy -f -"

if [ -n "${WAYLAND_DISPLAY}" ]; then
    outputdesc='capture active monitor output (Wayland)'
    if [ -n "${HYPRLAND_INSTANCE_SIGNATURE:-}" ]; then
        prog='grimblast'
        vss_cmd1="$prog --freeze save area $swappy"
        vss_cmd2="$prog --cursor --freeze save output $swappy"
        vss_cmd3="$prog --cursor --freeze save screen $swappy"
    elif [ -n "${SWAYSOCK:-}" ]; then
        prog='grimshot'
        vss_cmd1="$prog save area -"
        vss_cmd2="$prog --cursor save output $swappy"
        vss_cmd3="$prog --cursor save screen $swappy"
    else
        _panic 'Wayland error' "Current wayland platform '${XDG_CURRENT_DESKTOP:-}' is not supported!"
    fi
elif [ -n "${DISPLAY:-}" ]; then
    # only supports active window, not active monitor
    outputdesc='capture active window (X11)'
    prog='scrot'
    vss_cmd1="$prog -s -l mode=edge $swappy"
    vss_cmd2="$prog -up $swappy"
    vss_cmd3="$prog -mp $swappy"
fi

[ -z "${prog:-}" ] && _panic 'Platform error' "Current platform '${XDG_CURRENT_DESKTOP:-}' on tty '$(tty)' is not supported!"

missingdeps=''
for i in swappy "$prog"; do
    if ! command -v "$i" >/dev/null; then
        missingdeps="${missingdeps}$i "
    fi
done
[ -z "${missingdeps:-}" ] || _panic 'Dependency error' "Missing required dependencies: $missingdeps"

sel="${1:-}"
case "${sel:-}" in
1 | 2 | 3)
    comm=''
    eval "comm=\"\$vss_cmd${sel}\""
    dash -c "$comm"
    ;;
*)
    printf '%s\n' \
        "${0##*/} error, unrecognized option $sel" \
        "Available options:" \
        '1    select an area to capture' \
        "$vss_cmd1" \
        "2    $outputdesc" \
        "$vss_cmd2" \
        '3    capture entire multi-monitor screen' \
        "$vss_cmd3" \
        ''
    ;;
esac
